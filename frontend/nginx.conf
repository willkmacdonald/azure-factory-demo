# =============================================================================
# Nginx Configuration for React SPA (Single Page Application)
# =============================================================================
# This configuration is optimized for serving React applications with:
# - Client-side routing support (react-router-dom)
# - Security headers
# - Gzip compression
# - Caching for static assets
# - Health check endpoint
# =============================================================================

server {
    # Listen on port 80 (HTTP)
    # Azure Container Apps handles HTTPS termination, so we only need HTTP
    listen 80;
    server_name _;

    # Root directory where static files are served from
    root /usr/share/nginx/html;
    index index.html;

    # ==========================================================================
    # Security Headers
    # ==========================================================================
    # These headers protect against common web vulnerabilities

    # Prevent clickjacking attacks (don't allow embedding in iframes)
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Enable browser XSS filtering
    add_header X-XSS-Protection "1; mode=block" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Referrer policy (don't send full URL to external sites)
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy (CSP) - adjust as needed for your app
    # This is a permissive policy; tighten it based on your security requirements
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.azurecontainerapps.io https://*.azure.com" always;

    # ==========================================================================
    # Gzip Compression
    # ==========================================================================
    # Compress responses to reduce bandwidth and improve load times
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # ==========================================================================
    # Static Asset Caching
    # ==========================================================================
    # Cache static assets for 1 year (they have content hashes in filenames)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ==========================================================================
    # Runtime Environment Configuration
    # ==========================================================================
    # Serve runtime environment variables (generated by docker-entrypoint.sh)
    location /config/env.js {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        try_files $uri =404;
    }

    # ==========================================================================
    # SPA Routing Support
    # ==========================================================================
    # All routes should serve index.html (React Router handles client-side routing)
    # Exception: files with extensions (static assets) are served directly
    location / {
        # Try to serve the file directly, otherwise serve index.html
        # This allows:
        # - /assets/logo.png → serves the file
        # - /dashboard → serves index.html (React Router handles the route)
        # - /machines/123 → serves index.html (React Router handles the route)
        try_files $uri $uri/ /index.html;

        # No caching for index.html (always fetch latest)
        # This ensures users get the latest version after deployments
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }

    # ==========================================================================
    # Health Check Endpoint
    # ==========================================================================
    # Azure Container Apps uses this to verify the container is healthy
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ==========================================================================
    # Error Pages
    # ==========================================================================
    # Serve index.html for 404 errors (SPA routing)
    error_page 404 /index.html;

    # Hide Nginx version in error pages and headers (security)
    server_tokens off;
}
