# =============================================================================
# GitHub Actions Workflow: Deploy Backend to Azure Container Apps
# =============================================================================
# This workflow automates the CI/CD pipeline for the Factory Agent backend.
#
# Triggers:
# - Push to main branch (automatic deployment)
# - Manual workflow dispatch (on-demand deployment)
#
# Pipeline Stages:
# 1. Build: Build Docker image and run tests
# 2. Push: Push image to Azure Container Registry
# 3. Deploy: Deploy to Azure Container Apps
#
# Prerequisites (GitHub Secrets):
# - AZURE_CREDENTIALS: Service Principal credentials (JSON)
# - AZURE_SUBSCRIPTION_ID: Azure subscription ID
# - AZURE_RESOURCE_GROUP: Resource group name
# - AZURE_OPENAI_KEY: Azure OpenAI API key
# - AZURE_OPENAI_ENDPOINT: Azure OpenAI endpoint URL
# - AZURE_STORAGE_CONNECTION_STRING: Azure Storage connection string
#
# Setup Instructions:
# 1. Create Service Principal:
#    az ad sp create-for-rbac --name "factory-agent-github" \
#      --role contributor \
#      --scopes /subscriptions/{subscription-id}/resourceGroups/{rg-name} \
#      --sdk-auth
# 2. Copy JSON output and add as GitHub secret: AZURE_CREDENTIALS
# 3. Add other secrets in GitHub repo settings: Settings > Secrets > Actions
# =============================================================================

name: Deploy Backend to Azure Container Apps

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'shared/**'
      - 'infra/**'
      - '.github/workflows/deploy-backend.yml'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

# Environment variables used across all jobs
# Note: Resource names are environment-aware for multi-environment deployments
env:
  AZURE_CONTAINER_REGISTRY: ${{ secrets.AZURE_CONTAINER_REGISTRY || 'factoryagent4u4zqkacr' }}
  BACKEND_IMAGE_NAME: factory-agent/backend
  # Resource group and container app names use environment suffix from workflow input
  # Default to 'dev' for push-triggered deployments
  AZURE_RESOURCE_GROUP: factory-agent-${{ github.event.inputs.environment || 'dev' }}-rg
  CONTAINER_APP_NAME: factory-agent-${{ github.event.inputs.environment || 'dev' }}-backend

# Permissions required for OIDC authentication (alternative to service principal)
permissions:
  id-token: write
  contents: read

jobs:
  # ===========================================================================
  # JOB 1: Build and Test
  # ===========================================================================
  build:
    name: Build and Test Backend
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Checkout source code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Security Check: Validate DEBUG mode is disabled (PR24C)
      # -----------------------------------------------------------------------
      # Prevents accidentally deploying with DEBUG=true which exposes:
      # - Detailed error messages to clients
      # - Stack traces and internal paths
      # - Potential security vulnerabilities
      - name: Check DEBUG mode is disabled
        run: |
          echo "Checking for DEBUG mode in configuration files..."

          # Check .env.example for DEBUG=true (should be false)
          if grep -q "DEBUG=true" .env.example 2>/dev/null; then
            echo "::error::.env.example contains DEBUG=true - this should be DEBUG=false"
            exit 1
          fi

          # Check for hardcoded DEBUG=true in Python files
          if grep -rn "DEBUG\s*=\s*True" backend/src/ shared/ 2>/dev/null; then
            echo "::error::Hardcoded DEBUG=True found in source code"
            exit 1
          fi

          echo "âœ… DEBUG mode checks passed"

      # -----------------------------------------------------------------------
      # Set up Docker Buildx (advanced Docker build engine)
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Build Docker image (without pushing)
      # -----------------------------------------------------------------------
      # This validates that the Dockerfile builds successfully
      # Uses layer caching to speed up builds
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: false
          platforms: linux/amd64
          tags: ${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # Run Python tests (optional, uncomment when tests are ready)
      # -----------------------------------------------------------------------
      # - name: Set up Python
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: '3.11'
      #
      # - name: Install dependencies
      #   run: |
      #     cd backend
      #     pip install -r requirements.txt
      #     pip install pytest pytest-asyncio
      #
      # - name: Run tests
      #   run: |
      #     cd backend
      #     pytest tests/ -v

  # ===========================================================================
  # JOB 2: Push to Azure Container Registry
  # ===========================================================================
  push:
    name: Push to ACR
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      # -----------------------------------------------------------------------
      # Checkout source code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Set up Docker Buildx
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Log in to Azure
      # -----------------------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------------------------------
      # Log in to Azure Container Registry
      # -----------------------------------------------------------------------
      - name: Log in to ACR
        run: |
          az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      # -----------------------------------------------------------------------
      # Set image tag (commit SHA for traceability)
      # -----------------------------------------------------------------------
      - name: Set image tag
        id: set-tag
        run: |
          IMAGE_TAG="${{ github.sha }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Image tag: ${IMAGE_TAG}"

      # -----------------------------------------------------------------------
      # Build and push Docker image to ACR
      # -----------------------------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.BACKEND_IMAGE_NAME }}:${{ steps.set-tag.outputs.tag }}
            ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.BACKEND_IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # JOB 3: Deploy to Azure Container Apps
  # ===========================================================================
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: push
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      # -----------------------------------------------------------------------
      # Checkout source code (for Bicep templates)
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Log in to Azure
      # -----------------------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------------------------------
      # Deploy shared infrastructure (idempotent)
      # -----------------------------------------------------------------------
      # Creates/updates shared resources: Container Environment, Log Analytics, Identity
      # Safe to run on every deployment - only updates if changed
      - name: Deploy shared infrastructure
        run: |
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file ./infra/shared.bicep \
            --parameters \
              containerRegistryName="${{ env.AZURE_CONTAINER_REGISTRY }}" \
              environmentName="${{ github.event.inputs.environment || 'dev' }}"

      # -----------------------------------------------------------------------
      # Deploy backend infrastructure (idempotent)
      # -----------------------------------------------------------------------
      # Creates/updates ONLY backend Container App with backend image tag
      # This ensures frontend is NOT redeployed when backend changes
      - name: Deploy backend infrastructure
        run: |
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file ./infra/backend.bicep \
            --parameters \
              containerRegistryName="${{ env.AZURE_CONTAINER_REGISTRY }}" \
              imageTag="${{ needs.push.outputs.image-tag }}" \
              azureAiEndpoint="${{ secrets.AZURE_ENDPOINT }}" \
              azureAiKey="${{ secrets.AZURE_API_KEY }}" \
              azureAiDeployment="gpt-4o" \
              storageMode="blob" \
              azureStorageConnectionString="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              azureStorageContainerName="factory-data" \
              allowedOrigins="https://factory-agent-dev-frontend.mangotree-f82b3c1f.eastus.azurecontainerapps.io" \
              environmentName="${{ github.event.inputs.environment || 'dev' }}"

      # -----------------------------------------------------------------------
      # Get Container App URL
      # -----------------------------------------------------------------------
      - name: Get Container App URL
        id: get-url
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "url=https://${APP_URL}" >> $GITHUB_OUTPUT
          echo "Backend URL: https://${APP_URL}"

      # -----------------------------------------------------------------------
      # Test deployment (health check)
      # -----------------------------------------------------------------------
      - name: Test deployment
        run: |
          echo "Testing backend health endpoint..."
          sleep 30  # Wait for container to start

          HEALTH_URL="${{ steps.get-url.outputs.url }}/health"
          echo "Health check URL: ${HEALTH_URL}"

          # Retry health check up to 5 times with 10 second intervals
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL})
            if [ $HTTP_STATUS -eq 200 ]; then
              echo "âœ… Health check passed (HTTP ${HTTP_STATUS})"
              curl -s ${HEALTH_URL} | jq '.'
              exit 0
            else
              echo "â³ Health check attempt ${i}/5 failed (HTTP ${HTTP_STATUS})"
              sleep 10
            fi
          done

          echo "âŒ Health check failed after 5 attempts"
          exit 1

      # -----------------------------------------------------------------------
      # Create GitHub deployment summary
      # -----------------------------------------------------------------------
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend API URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [API Documentation](${{ steps.get-url.outputs.url }}/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- [Health Check](${{ steps.get-url.outputs.url }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/overview)" >> $GITHUB_STEP_SUMMARY

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
# If deployment fails:
# 1. Check GitHub Actions logs for error messages
# 2. Verify all secrets are configured correctly in GitHub
# 3. Check Azure Container Apps logs:
#    az containerapp logs show -n factory-agent-dev-backend -g factory-agent-rg --follow
# 4. Check Azure Container Registry for pushed images:
#    az acr repository show-tags -n factoryagent4u4zqkacr --repository factory-agent/backend
# 5. Validate Bicep template locally:
#    az deployment group validate --resource-group factory-agent-rg --template-file infra/main.bicep --parameters infra/main.bicepparam
