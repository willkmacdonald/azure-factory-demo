# =============================================================================
# GitHub Actions Workflow: Deploy Frontend to Azure Static Web Apps
# =============================================================================
# This workflow automates the CI/CD pipeline for the Factory Agent frontend.
#
# Triggers:
# - Push to main branch (automatic deployment)
# - Manual workflow dispatch (on-demand deployment)
#
# Pipeline Stages:
# 1. Install: npm ci
# 2. Build: Vite builds React app with VITE_API_BASE_URL
# 3. Deploy: Upload to Azure Static Web Apps
#
# Prerequisites (GitHub Secrets):
# - AZURE_STATIC_WEB_APPS_API_TOKEN: SWA deployment token
# - VITE_API_BASE_URL: Backend Container App URL
# =============================================================================

name: Deploy Frontend (Static Web Apps)

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Checkout source code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Set up Node.js with npm caching
      # -----------------------------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # -----------------------------------------------------------------------
      # Install dependencies and build
      # -----------------------------------------------------------------------
      - name: Install and build
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: |
          npm ci
          npm run build
          cp staticwebapp.config.json dist/

      # -----------------------------------------------------------------------
      # Deploy to Azure Static Web Apps
      # -----------------------------------------------------------------------
      - name: Deploy to Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'frontend/dist'
          output_location: ''
          skip_app_build: true

      # -----------------------------------------------------------------------
      # Create GitHub deployment summary
      # -----------------------------------------------------------------------
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** https://gray-ground-0bab7600f.2.azurestaticapps.net" >> $GITHUB_STEP_SUMMARY
          echo "**Backend API URL:** ${{ secrets.VITE_API_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Frontend Application](https://gray-ground-0bab7600f.2.azurestaticapps.net)" >> $GITHUB_STEP_SUMMARY
          echo "- [Backend API Documentation](${{ secrets.VITE_API_BASE_URL }}/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- [Backend Health Check](${{ secrets.VITE_API_BASE_URL }}/health)" >> $GITHUB_STEP_SUMMARY

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
# If deployment fails:
# 1. Check GitHub Actions logs for error messages
# 2. Verify secrets are configured:
#    - AZURE_STATIC_WEB_APPS_API_TOKEN (from: az staticwebapp secrets list)
#    - VITE_API_BASE_URL (backend Container App URL)
# 3. Verify frontend builds locally:
#    cd frontend && npm ci && npm run build
# 4. Check SWA resource in Azure Portal
# 5. View SWA logs:
#    az staticwebapp show -n factory-agent-dev-frontend-swa -g factory-agent-dev-rg
