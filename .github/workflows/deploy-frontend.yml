# =============================================================================
# GitHub Actions Workflow: Deploy Frontend to Azure Container Apps
# =============================================================================
# This workflow automates the CI/CD pipeline for the Factory Agent frontend.
#
# Triggers:
# - Push to main branch (automatic deployment)
# - Manual workflow dispatch (on-demand deployment)
#
# Pipeline Stages:
# 1. Build: Build Docker image for React + Nginx
# 2. Push: Push image to Azure Container Registry
# 3. Deploy: Deploy to Azure Container Apps
#
# Prerequisites (GitHub Secrets):
# - AZURE_CREDENTIALS: Service Principal credentials (JSON)
# - AZURE_SUBSCRIPTION_ID: Azure subscription ID
# - AZURE_RESOURCE_GROUP: Resource group name
# - AZURE_OPENAI_KEY: Azure OpenAI API key (for backend)
# - AZURE_OPENAI_ENDPOINT: Azure OpenAI endpoint URL (for backend)
# - AZURE_STORAGE_CONNECTION_STRING: Azure Storage connection string (for backend)
#
# Note: Frontend and backend share the same Azure infrastructure,
# so they use the same GitHub secrets for deployment.
# =============================================================================

name: Deploy Frontend to Azure Container Apps

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'infra/**'
      - '.github/workflows/deploy-frontend.yml'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

# Environment variables used across all jobs
# Use repository variables with fallback to default values for backward compatibility
# To set repository variables: GitHub Settings > Secrets and variables > Actions > Variables
env:
  AZURE_CONTAINER_REGISTRY: ${{ vars.AZURE_CONTAINER_REGISTRY || 'factoryagentdevacr' }}
  FRONTEND_IMAGE_NAME: factory-agent/frontend
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP || 'factory-agent-dev-rg' }}
  CONTAINER_APP_NAME: ${{ vars.CONTAINER_APP_NAME || 'factory-agent-dev-frontend' }}

# Permissions required for OIDC authentication (alternative to service principal)
permissions:
  id-token: write
  contents: read

jobs:
  # ===========================================================================
  # JOB 1: Build and Test
  # ===========================================================================
  build:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Checkout source code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Set up Docker Buildx (advanced Docker build engine)
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Build Docker image (without pushing)
      # -----------------------------------------------------------------------
      # This validates that the Dockerfile builds successfully
      # Uses layer caching to speed up builds
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: false
          platforms: linux/amd64
          tags: ${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # Optional: Run frontend tests
      # -----------------------------------------------------------------------
      # Uncomment when frontend tests are added
      # - name: Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '22'
      #     cache: 'npm'
      #     cache-dependency-path: frontend/package-lock.json
      #
      # - name: Install dependencies
      #   run: |
      #     cd frontend
      #     npm ci
      #
      # - name: Run tests
      #   run: |
      #     cd frontend
      #     npm run test

  # ===========================================================================
  # JOB 2: Push to Azure Container Registry
  # ===========================================================================
  push:
    name: Push to ACR
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      # -----------------------------------------------------------------------
      # Checkout source code
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Set up Docker Buildx
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Log in to Azure
      # -----------------------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------------------------------
      # Log in to Azure Container Registry
      # -----------------------------------------------------------------------
      - name: Log in to ACR
        run: |
          az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      # -----------------------------------------------------------------------
      # Set image tag (commit SHA for traceability)
      # -----------------------------------------------------------------------
      - name: Set image tag
        id: set-tag
        run: |
          IMAGE_TAG="${{ github.sha }}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Image tag: ${IMAGE_TAG}"

      # -----------------------------------------------------------------------
      # Build and push Docker image to ACR
      # -----------------------------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.FRONTEND_IMAGE_NAME }}:${{ steps.set-tag.outputs.tag }}
            ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.FRONTEND_IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # JOB 3: Deploy to Azure Container Apps
  # ===========================================================================
  deploy:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: push
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      # -----------------------------------------------------------------------
      # Checkout source code (for Bicep templates)
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Log in to Azure
      # -----------------------------------------------------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------------------------------
      # Deploy infrastructure with Bicep (idempotent)
      # -----------------------------------------------------------------------
      # This creates or updates all Azure resources defined in main.bicep
      # Azure Resource Manager only updates resources that have changed
      - name: Deploy Azure infrastructure
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: >
            containerRegistryName=${{ env.AZURE_CONTAINER_REGISTRY }}
            imageTag=${{ needs.push.outputs.image-tag }}
            azureAiEndpoint=${{ secrets.AZURE_ENDPOINT }}
            azureAiKey=${{ secrets.AZURE_API_KEY }}
            azureAiDeployment=gpt-4o
            storageMode=local
            environmentName=${{ github.event.inputs.environment || 'dev' }}
          failOnStdErr: false

      # -----------------------------------------------------------------------
      # Get Container App URLs
      # -----------------------------------------------------------------------
      - name: Get Container App URLs
        id: get-urls
        run: |
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "frontend-url=https://${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "Frontend URL: https://${FRONTEND_URL}"

          BACKEND_URL=$(az containerapp show \
            --name factory-agent-dev-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "backend-url=https://${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "Backend URL: https://${BACKEND_URL}"

      # -----------------------------------------------------------------------
      # Test deployment (health check)
      # -----------------------------------------------------------------------
      - name: Test deployment
        run: |
          echo "Testing frontend health endpoint..."
          sleep 30  # Wait for container to start

          HEALTH_URL="${{ steps.get-urls.outputs.frontend-url }}/health"
          echo "Health check URL: ${HEALTH_URL}"

          # Retry health check up to 5 times with 10 second intervals
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL})
            if [ $HTTP_STATUS -eq 200 ]; then
              echo "âœ… Health check passed (HTTP ${HTTP_STATUS})"
              exit 0
            else
              echo "â³ Health check attempt ${i}/5 failed (HTTP ${HTTP_STATUS})"
              sleep 10
            fi
          done

          echo "âŒ Health check failed after 5 attempts"
          exit 1

      # -----------------------------------------------------------------------
      # Test end-to-end connectivity
      # -----------------------------------------------------------------------
      - name: Test frontend to backend connectivity
        run: |
          echo "Testing frontend configuration..."

          # Fetch the frontend page
          FRONTEND_URL="${{ steps.get-urls.outputs.frontend-url }}"
          echo "Fetching frontend from: ${FRONTEND_URL}"

          # Check if env.js is being served
          ENV_JS_URL="${FRONTEND_URL}/config/env.js"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${ENV_JS_URL})

          if [ $HTTP_STATUS -eq 200 ]; then
            echo "âœ… Runtime environment configuration is accessible"
            curl -s ${ENV_JS_URL}
          else
            echo "âš ï¸  Runtime environment configuration not found (HTTP ${HTTP_STATUS})"
            echo "This is expected if docker-entrypoint.sh hasn't run yet"
          fi

          # Test backend connectivity from outside
          BACKEND_URL="${{ steps.get-urls.outputs.backend-url }}"
          BACKEND_HEALTH="${BACKEND_URL}/health"
          echo "Testing backend health: ${BACKEND_HEALTH}"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${BACKEND_HEALTH})
          if [ $HTTP_STATUS -eq 200 ]; then
            echo "âœ… Backend is healthy and accessible (HTTP ${HTTP_STATUS})"
          else
            echo "âš ï¸  Backend health check failed (HTTP ${HTTP_STATUS})"
          fi

      # -----------------------------------------------------------------------
      # Create GitHub deployment summary
      # -----------------------------------------------------------------------
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ steps.get-urls.outputs.frontend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend API URL:** ${{ steps.get-urls.outputs.backend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Frontend Application](${{ steps.get-urls.outputs.frontend-url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Backend API Documentation](${{ steps.get-urls.outputs.backend-url }}/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- [Backend Health Check](${{ steps.get-urls.outputs.backend-url }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/overview)" >> $GITHUB_STEP_SUMMARY

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
# If deployment fails:
# 1. Check GitHub Actions logs for error messages
# 2. Verify all secrets are configured correctly in GitHub
# 3. Check Azure Container Apps logs:
#    az containerapp logs show -n factory-agent-dev-frontend -g factory-agent-rg --follow
# 4. Check Azure Container Registry for pushed images:
#    az acr repository show-tags -n factoryagentdevacr --repository factory-agent/frontend
# 5. Validate Bicep template locally:
#    az deployment group validate --resource-group factory-agent-rg --template-file infra/main.bicep
# 6. Verify Docker image builds locally:
#    docker build -f frontend/Dockerfile -t factory-agent/frontend .
#    docker run -p 3000:80 -e VITE_API_BASE_URL=http://localhost:8000 factory-agent/frontend
